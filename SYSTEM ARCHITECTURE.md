# FACE IMAGE ENHANCEMENT & RESTORATION  
## SYSTEM ARCHITECTURE DESIGN DOCUMENT

> GPU-ACCELERATED, ASYNCHRONOUS, CLIENT–SERVER PLATFORM FOR HIGH-QUALITY FACE RESTORATION  
> THIS DOCUMENT DEFINES THE HIGH-LEVEL ENGINEERING FOUNDATION FOR THE PROJECT.

---

## 1. SYSTEM OVERVIEW

THE SYSTEM IS A STATELESS, CLIENT–SERVER WEB APPLICATION DESIGNED FOR FAST, SECURE, AND GPU-ACCELERATED IMAGE RESTORATION.

```
BROWSER (NEXT.JS + REACT + TYPESCRIPT)
            │
            │ HTTPS (MULTIPART + JSON)
            ▼
        FASTAPI GATEWAY
            │
            ▼
   IMAGE PROCESS PIPELINE
            │
            ▼
      MODEL SERVICE LAYER
            │
            ▼
        GPU / CPU (CUDA)
```

### COMPONENT RESPONSIBILITIES

**FRONTEND**
- IMAGE UPLOAD
- FILE VALIDATION
- PREVIEW
- PROGRESS INDICATOR
- BEFORE/AFTER COMPARISON
- METRICS DISPLAY
- DOWNLOAD SUPPORT

**API GATEWAY (FASTAPI)**
- REQUEST VALIDATION
- ERROR HANDLING
- CORS & SECURITY
- ASYNC ROUTING
- THREADPOOL EXECUTION FOR HEAVY TASKS

**PROCESSING SERVICE**
- FACE DETECTION
- FACE ALIGNMENT
- COLOR CORRECTION
- RESTORATION
- UPSCALING
- IDENTITY VERIFICATION
- QUALITY METRICS

**MODEL LAYER**
- GFPGAN
- REAL-ESRGAN
- INSIGHTFACE
- FACE DETECTOR

---

## 2. API COMMUNICATION DESIGN

### ENDPOINT
`POST /api/v1/enhance`

### REQUEST
Content-Type: multipart/form-data

PARAMETERS:
- file (JPEG / PNG)
- upscale_factor (optional, default=2)

### RESPONSE FORMAT

```json
{
  "status": "success",
  "data": {
    "restored_image": "base64_string",
    "metrics": {
      "psnr": 28.5,
      "ssim": 0.89,
      "lpips": 0.21,
      "identity_similarity": 0.78
    },
    "processing_time_ms": 1250,
    "warning": null
  }
}
```

### DESIGN RATIONALE

| OPTION | REASON NOT USED |
|--------|-----------------|
| STREAMING | COMPLEX UI, HARDER METRICS DELIVERY |
| WEBSOCKETS | OVERKILL FOR SINGLE IMAGE |
| GRPC | NOT BROWSER FRIENDLY |

**BASE64 TRADEOFF**
- EASY BROWSER RENDERING
- SIMPLE DOWNLOAD
- ~33% SIZE OVERHEAD (ACCEPTABLE FOR PORTFOLIO SCOPE)

---

## 3. REQUEST LIFECYCLE

### USER FLOW

1. USER SELECTS IMAGE
2. FRONTEND VALIDATES TYPE & SIZE (<10MB)
3. IMAGE PREVIEW DISPLAYED
4. USER CLICKS ENHANCE
5. REQUEST SENT VIA AXIOS
6. FASTAPI VALIDATES INPUT
7. IMAGE LOADED INTO MEMORY (NUMPY)
8. PIPELINE EXECUTION
9. METRICS COMPUTED
10. OUTPUT ENCODED (BASE64)
11. JSON RESPONSE RETURNED
12. UI UPDATED WITH RESULTS

---

## 4. PROCESSING PIPELINE

### PRE-PROCESSING
- FACE DETECTION
- LANDMARK ALIGNMENT
- OPTIONAL COLOR CORRECTION

### CORE INFERENCE
- **GFPGAN** → FACE RESTORATION
- **REAL-ESRGAN** → BACKGROUND UPSCALING
- SOFT MASK BLENDING (PASTE-BACK)

### VERIFICATION
- INSIGHTFACE EMBEDDINGS
- COSINE SIMILARITY
- IF BELOW THRESHOLD → WARNING FLAG

### METRICS
- PSNR
- SSIM
- LPIPS
- IDENTITY SIMILARITY

---

## 5. IN-MEMORY PROCESSING POLICY

NO FILES ARE WRITTEN TO DISK.

BENEFITS:
- FASTER I/O
- IMPROVED SECURITY
- STATELESS DESIGN
- CLOUD READY

---

## 6. MODEL LOADING STRATEGY

### SINGLETON INITIALIZATION

MODELS ARE LOADED ON APPLICATION STARTUP:

```python
@app.on_event("startup")
```

CONFIGURATION:
- eval() MODE
- torch.no_grad()
- OPTIONAL FP16 (IF SUPPORTED)

### TRADEOFF

| BENEFIT | COST |
|--------|------|
| LOW LATENCY | HIGHER VRAM USAGE |
| STABLE CUDA CONTEXT | SLOW COLD START |

RECOMMENDED VRAM: ≥ 4GB

---

## 7. GPU MANAGEMENT

- SINGLE GPU ASSUMED
- ALL MODELS SHARE SAME DEVICE
- EXPLICIT `.to(device)`
- CPU FALLBACK AVAILABLE (SLOW)

### OPTIMIZATION
- FP16 SUPPORT
- MODEL WARMUP
- SEMAPHORE FOR CONCURRENCY CONTROL

**RULE:** MAX 1–2 CONCURRENT INFERENCES PER GPU

---

## 8. INTERNAL IMAGE DATA CONTRACT

INPUT:
- COLOR: RGB
- TYPE: float32
- RANGE: [0, 1]
- SHAPE: (H, W, 3)

OUTPUT:
- SAME FORMAT

PURPOSE:
- PREVENT SILENT BUGS
- ENSURE METRIC VALIDITY
- ENABLE MODULE SWAPPING

---

## 9. ERROR HANDLING

### ERROR TYPES

**CLIENT (4XX)**
- INVALID FILE TYPE
- IMAGE TOO LARGE
- NO FACE DETECTED

**PIPELINE (5XX)**
- MODEL FAILURE
- GPU OUT OF MEMORY
- METRIC FAILURE

**SYSTEM**
- MODEL NOT LOADED
- CUDA ERROR

### ERROR RESPONSE

```json
{
  "error": "Human readable message",
  "stage": "pipeline_stage"
}
```

FRONTEND BEHAVIOR:
- DISPLAY ERROR MESSAGE
- ALLOW RETRY
- NO UI CRASH

---

## 10. PERFORMANCE ANALYSIS

### BOTTLENECKS

| STAGE | COST |
|------|------|
| GFPGAN | HIGH GPU |
| REAL-ESRGAN | VERY HIGH GPU |
| FACE DETECTION | MODERATE |
| METRICS | LOW |

### EXPECTED LATENCY
**2–4 SECONDS (GPU)**

### OPTIMIZATIONS
- THREADPOOL EXECUTION (`run_in_threadpool`)
- NO GRADIENT COMPUTATION
- IMAGE SIZE LIMIT
- MODEL WARMUP
- MINIMAL MEMORY COPIES

---

## 11. SCALABILITY ROADMAP

THIS ARCHITECTURE SUPPORTS FUTURE EXTENSIONS:

- HORIZONTAL SCALING (MULTIPLE INSTANCES)
- NGINX LOAD BALANCING
- REDIS + CELERY TASK QUEUE
- S3 STORAGE + URL RESPONSE
- VIDEO PROCESSING PIPELINE
- MULTI-GPU SUPPORT

DESIGNED TO BE EXTENSIBLE WITHOUT OVER-ENGINEERING.

---

## 12. PRODUCTION RISKS & MITIGATION

| RISK | MITIGATION |
|------|------------|
| GPU OOM | IMAGE SIZE LIMIT + CONCURRENCY CONTROL |
| COLD START | MODEL WARMUP |
| IDENTITY DRIFT | INSIGHTFACE THRESHOLD + WARNING |
| GENERATION ARTIFACTS | GFPGAN WEIGHT TUNING |
| LARGE PAYLOADS | SIZE RESTRICTION |
| USER SPAM | RATE LIMITING (FUTURE) |

---

## 13. KEY ARCHITECTURAL PRINCIPLES

- STATELESS REST DESIGN
- IN-MEMORY PROCESSING
- SINGLETON GPU MODELS
- CONTROLLED GPU CONCURRENCY
- STRICT IMAGE DATA CONTRACT
- IDENTITY PRESERVATION
- TRANSPARENT QUALITY METRICS
- PRODUCTION-READY FOUNDATION

---

## 14. SYSTEM CHARACTERISTICS

| PROPERTY | VALUE |
|---------|-------|
| LATENCY | 2–4s (GPU) |
| VRAM | ~4–6GB |
| THROUGHPUT | ~1 REQUEST / GPU |
| RELIABILITY | HIGH |
| ARCHITECTURE LEVEL | PRODUCTION-GRADE |
| PURPOSE | PORTFOLIO + REAL-WORLD READY |

---

## FINAL NOTE

THIS DOCUMENT IS THE **FOUNDATIONAL ENGINEERING BLUEPRINT**.  
ALL IMPLEMENTATION DECISIONS MUST ALIGN WITH THIS ARCHITECTURE.

ANY CHANGES SHOULD BE MADE DELIBERATELY AND DOCUMENTED.
